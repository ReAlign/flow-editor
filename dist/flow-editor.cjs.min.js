"use strict";const _={typeOf:e=>null===e?String(e):{}.toString.call(e).slice(8,-1).toLowerCase(),merge:(e={},t={})=>{const n=_.typeOf(e),i=_.typeOf(t);if(n!==i)return t;switch(i){case"object":for(let n in t)t.hasOwnProperty(n)&&(e[n]=_.merge(e[n],t[n]));break;case"array":for(let n=0;n<t.length;n++)e[n]=_.merge(e[n],t[n]);e.length=t.length;break;default:return t}return e},deepClone:e=>{const t=e=>{let i,s,a={};for(let r in e)i=e[r],s=_.typeOf(i),a[r]="object"===s?t(i):"array"===s?n(i):i;return a},n=e=>{let i,s,a=[];for(let r=0;r<e.length;r++)i=e[r],"object"===(s=_.typeOf(i))?a[r]=t(i):"array"===s?a[r]=n(i):"object"!=typeof i&&(a[r]=i);return a};switch(_.typeOf(e)){case"object":return t(e);case"array":return n(e);default:return e}},get:(e={},t="",n="")=>{if(""===t)return e;return("array"===_.typeOf(t)?t:t.replace(/\[/g,".").replace(/'|"|\]/g,"").split(".")).reduce((e,t)=>(e||{})[t],e)||n},deepGet:(e={},t="",n="")=>_.deepClone(_.get(e,t,n)),compareXY:(e=0,t=0)=>"number"!==_.typeOf(e)||"number"!==_.typeOf(t)?null:e<t?-1:e===t?0:e>t?1:void 0,arrayContainsVal:(e=[],t="")=>void 0!==e&&null!==e&&void 0!==t&&null!==t&&-1!==e.indexOf(t),getPixelRatio:(e=null)=>{if(!e)return null;const t=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/t},removeSuffix:(e="",t="")=>"string"!==_.typeOf(e)&&"string"!==_.typeOf(t)?e:e&&t?e.length<=t.length?e:e.substr(0,e.length-t.length):e},u={_getTargetPath:(e=null)=>{const t=[],n=(e=null)=>{if(!e)return null;e.parent&&(t.unshift(e.siblingsIndex),n(e.parent))};return n(e),t},_addUniqueSuffix:(e="")=>{return`${e}${`-${+Date.now()}-${parseInt(1e4*Math.random())}`}`},_makeConsoleStr:(e=[])=>{if(!e||"array"!==_.typeOf(e)||!e.length)return null;let t="\n";return e.forEach(e=>{t+=`\n\t\t${e}`}),`${t}\n`},getShapeAndShapeOrigin:(e=null)=>{const t=_.get(e,"shape");return{_shape:t,_shapeOrigin:t.split("__")[0]}},collectHighlightDataOfShape:(e="",t=null,n=null)=>{const{scaleRatio:i,styles:s}=n,{shape:a}=s,{_shape:r,_shapeOrigin:o}=u.getShapeAndShapeOrigin(t),l={};if(_.merge(l,_.get(a,`${r}.highlight`,null)),_.merge(l,_.get(a,`${o}.highlight`,null)),e&&l){let n=null;const s=_.get(l,`${e}.bg`),h=_.get(a,`${r}.rBorder`)||_.get(a,`${o}.rBorder`),c=_.get(l,`${e}.border`);if(c){const e=c.split(" ");if(e&&e.length>=2){const t=e[0];e[1];n={type:"stroke",strokeColor:e.filter((e,t)=>t>1).join(" "),lineWidth:parseInt(t)}}}const d={scaleRatio:i,shapeOrigin:o,x:t.x-t.width/2,y:t.y,w:t.width,h:t.height,rBorder:h},u={type:"fill",fillColor:s};return{fillOpts:_.merge(u,d),strokeOpts:null===n?null:_.merge(n,d)}}return null},createCrossOriginImage:(e="")=>{const t=new Image;return t.setAttribute("crossOrigin","Anonymous"),t.src=e,t}},dom={};dom.msie=parseInt((/msie (\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1]),isNaN(dom.msie)&&(dom.msie=parseInt((/trident\/.*; rv:(\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1])),dom.$=((e="")=>{if(document.querySelector)try{return document.querySelector(e)}catch(e){throw new Error(e)}if(-1!==e.indexOf("#"))return document.getElementById(e.slice(1))}),dom.text=function(){const e={};return dom.msie&&dom.msie<9?(e[1]="innerText",e[3]="nodeValue"):e[1]=e[3]="textContent",function(t,n){let i=e[t.nodeType];if(null===n)return i?t[i]:"";t[i]=n}}(),dom.html=((e=null,t="")=>{if("undefined"===_.typeOf(t))return e.innerHTML;e.innerHTML=t}),dom.create=((e="")=>e?document.createElement(e):null),dom.inject=((e=null,t=null)=>{if(!e)return null;if(Array.isArray(e)){let t=e;e=dom.fragment();for(let n=0,i=t.length;n<i;n++)e.appendChild(t[n])}t.appendChild(e)}),dom.createStyle=((e="")=>{const t=dom.create("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e));const n=dom.$("head");n&&n.appendChild(t)}),dom.disabledMouseWheel=((e={})=>{const{domEle:t=document,flag:n=!0}=e,i=n?()=>!1:()=>!0;document.addEventListener&&t.addEventListener("DOMMouseScroll",i,!1),t.onmousewheel=i});const Config={DELAY:{simulateClick:400},padding:20,hiddenWidth:18,canvasList:["canvas","canvasHover","canvasActive"],originText:()=>{return{family:"Arial",color:"#fff",size:12,lineHeight:12,align:"center",indent:0,maxLen:10}},originHighlight:(e="")=>{return{error:{bg:"rgba(255, 51, 51, .2)",border:"1px solid rgba(255, 51, 51, 1)",rBorder:2},hover:{bg:"rgba(255, 255, 255, 0)",border:"1px solid rgba(51, 126, 255, 1)",rBorder:2},active:{bg:"rgba(26, 110, 255, .2)",border:"1px solid rgba(51, 126, 255, 1)",rBorder:2}}[e]||null},_shapeNormalConf:(e=null)=>{const t={bg:"#4caf50",highlight:{hover:Config.originHighlight("hover"),active:Config.originHighlight("active"),error:Config.originHighlight("error")},text:Config.originText()};return e&&_.merge(t,e),t},privateOriginPoint:()=>({__originPoint:{x:0,y:0}}),privateBoundaryPoint:()=>({__boundaryPoint:{x:{min:0,max:0},y:{min:0,max:0}}}),originOptions:()=>{return{styles:{canvas:{bg:"#fff",bgImg:""},size:{width:120,height:36},gutter:{vertical:100,horizontal:60},shape:{circle:Config._shapeNormalConf(),rectangle:Config._shapeNormalConf(),"round-rectangle":Config._shapeNormalConf({rBorder:2}),rhombus:Config._shapeNormalConf(),ellipse:Config._shapeNormalConf(),triangle:Config._shapeNormalConf()},line:{color:"#61afef",width:1,borderRadius:6}},eventBind:{click:!1,contextmenu:!1,mouse:!1},events:{click(){},contextmenu(){},mousemove(){},mouseover(){},mouseout(){},clickEmpty(){}}}}},View={getCustomScrollbarStyle:(e="")=>{let t="";return e&&(t=`\n            .${e}::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n            .${e}::-webkit-scrollbar-thumb {\n                background: #ccc;\n                border-radius: 4px;\n                transition: background .3s;\n            }\n            .${e}::-webkit-scrollbar-track-piece {\n                background-color: rgba(255, 255, 255, 0);\n                border-radius: 4px;\n            }\n            .${e}::-webkit-scrollbar-thumb:vertical:hover {\n                background: #a0a0a0;\n            }\n            .${e}::-webkit-scrollbar-thumb:horizontal:hover {\n                background: #a0a0a0;\n            }\n        `),t},createStyleStr:(e="",t=null)=>{let n="";if(e&&t){let i="";Object.keys(t).forEach(e=>{i+=`\n                ${e}: ${t[e]};\n            `}),n=`\n            .${e} {\n                ${i}\n            }\n        `}return n},getDraggGrabStyle:(e="")=>{let t="";return e&&(t=`\n            .${e} {\n                cursor: grab;\n            }\n            .${e}:active {\n                cursor : grabbing;\n            }\n        `),t}},CONST={};CONST.PI2=2*Math.PI,CONST.getShapeOptions=((e={})=>{const{x:t,y:n,w:i,h:s}=e;return e.cx=t+i/2,e.cy=n+s/2,e.w2=i/2,e.h2=s/2,e.r=Math.min(e.w2,e.h2),e}),CONST.draw=((e="",t=null,n={})=>new Promise((i,s)=>{const a=CONST.getShapeOptions(n),{scaleRatio:r=1,x:o=-1,y:l=-1,cx:h=0,cy:c=0,w:d=0,h:g=0,w2:p=0,h2:m=0,r:f=0,lineWidth:v=1,type:_="",fillColor:y="",strokeColor:w="",bgImg:x="",rBorder:C=2,polygon:E=null,polygonXYsArr:S=null}=a;t.beginPath(),t.shadowBlur=10*r,t.shadowColor="rgba(0, 0, 0, .1)",t.shadowOffsetX=2*r,t.shadowOffsetY=2*r;const b=C*r;switch(e){case"circle":t.arc(h,c,f,0,CONST.PI2);break;case"rectangle":t.moveTo(o,l+b),t.lineTo(o,l+g-b),t.quadraticCurveTo(o,l+g,o+b,l+g),t.lineTo(o+d-b,l+g),t.quadraticCurveTo(o+d,l+g,o+d,l+g-b),t.lineTo(o+d,l+b),t.quadraticCurveTo(o+d,l,o+d-b,l),t.lineTo(o+b,l),t.quadraticCurveTo(o,l,o,l+b);break;case"polygonXYs":{const e=S;t.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)t.lineTo(e[n].x,e[n].y);break}}if("stroke"===_&&(t.lineWidth=v*r),x){const e=u.createCrossOriginImage(x);e.onload=(()=>{t.closePath(),t.drawImage(e,o,l,d,g),t.shadowBlur=0,t.shadowColor=null,t.shadowOffsetX=0,t.shadowOffsetY=0,i(a)})}else t[`${_}Style`]=n[`${_}Color`],t.closePath(),t[_](),t.shadowBlur=0,t.shadowColor=null,t.shadowOffsetX=0,t.shadowOffsetY=0,i(a)})),CONST.containPoint=((e="",t=null,n={})=>{const{x:i,y:s}=t,{x:a,y:r,cx:o,cy:l,w:h,h:c,r:d}=n;if(null===i||null===s)return!1;let u=!1;switch(e){case"circle":u=Math.pow(i-o,2)+Math.pow(s-l,2)-Math.pow(d,2)<=0;break;case"rectangle":u=i<=a+h&&s<=r+c&&i>=a&&s>=r;break}return{flag:u,loc:{x:a-i,y:r-s}}});class TargetArray{constructor(){this._data=[],this.selectedElements=[],this.unSelectedElements=[]}add(e=null){if(!e)return;const t=this._data,n=t.length;let i=0;for(let s=0;s<n;s++){const n=t[s],a=e.compareTo(n);if(null===a)return;if(!(a>0))break;i++}for(let e=n;e>i;e--)t[e]=t[e-1];t[i]=e}contains(e=null){if(null==e)return!1;const t=this._data;let n=t.length-1,i=0,s=null;for(;i<=n;){if(t[s=parseInt((i+n)/2)]===e)return!0;t[s].compareTo(e)<0?i=s+1:n=s-1}return!1}search(e=null){const t=this,n=t._data,i=n.length;let s=null;t.selectedElements.length=0,t.unSelectedElements.length=0;for(var a=0;a<i;a++){const i=(s=n[a]).hasPoint(e);s.loc=i.loc,i.flag?t.selectedElements.push(s):t.unSelectedElements.push(s)}for(;a<i;a++)s=n[a],t.unSelectedElements.push(s)}delete(e=null){const t=this._data,n=t.length;let i=-1;for(let s=0;s<n;s++)if(e===t[s]){i=s;break}t.splice(i,1)}reset(){this._data.length=0,this.selectedElements.length=0,this.unSelectedElements.length=0}}class EventManager{constructor(){this._targets={}}getTargets(e=""){const t=this._getEventTypePrefix(e);return t?this._targets[t]:null}addTarget(e="",t=null){const n=this._targets,i=this._getEventTypePrefix(e);if(!i)return;n.hasOwnProperty(i)||(n[i]=new TargetArray);const s=n[i];s.contains(t)||s.add(t)}removeTarget(e="",t=null){const n=this._targets,i=this._getEventTypePrefix(e);i&&n.hasOwnProperty(i)&&n[e].delete(t)}_filterSupportEventType(e=""){let t=null;return 0===e.indexOf("mouse")&&(t="mouse"),"click"===e&&(t="click"),"contextmenu"===e&&(t="contextmenu"),t}_getEventTypePrefix(e=""){return e?this._filterSupportEventType(e):null}}var EventManager$1=new EventManager;class EventTarget{constructor(){this._listeners={},this.inBounds=!1}hasListener(e="",t=""){const n=this._listeners;return n[e]&&n[e].hasOwnProperty(t)}addListener(e="",t="",n=null){const i=this._listeners;e&&t&&n&&(i[e]||(i[e]={}),i[e].hasOwnProperty(t)||(i[e][t]=[]),i[e][t].push(n),EventManager$1.addTarget(t,this))}fire(e={}){const t=this,{scope:n="",type:i="",FENodeEvent:s=null,attach:a=null,eventFrom:r=""}=e,o=t._listeners,l=t.loc;if(n&&i&&null!==s&&null!==s.type){if("array"===_.typeOf(o[n][s.type])){const e=o[n][s.type],h=e.length;if(h){const n=[];for(let o=0;o<h;o++){const h=_.get(s,"target.options.data",{}),c=_.get(a,"event",{}),d=c.x+l.x,u=c.y+l.y,g=d+h.width,p=u+h.height;e[o].call(t,{type:i,target:h,targetPath:h.path,targetAttach:h.attachInfo,event:c,eventFrom:r,shapePoint:{topLeft:{x:d,y:u},topRight:{x:g,y:u},bottomLeft:{x:d,y:p},bottomRight:{x:g,y:p}}}),n.push({target:h,targetPath:h.path,targetAttach:h.attachInfo})}return n}}return null}}removeListener(e="",t="",n=null){const i=this,s=i._listeners;if(e&&t&&n&&(null===n&&s[e]&&s[e].hasOwnProperty(t)&&(s[e][t]=[],EventManager$1.removeTarget(t,i)),"array"===_.typeOf(s[e][t]))){const i=s[e][t],a=i.length;for(let e=0;e<a;e++)if(i[e]===n){i.splice(e,1),i.length||EventManager$1.removeTarget(t,this);break}}}}class ShapeBase extends EventTarget{constructor(e,t){super(),this.canvas=e,this.context=t,this.options=null}draw(e){}compareTo(e){return null}comparePointX(e){return null}hasPoint(e){return!1}}class Circle extends ShapeBase{constructor(e=null,t=null){super(e,t)}draw(e={}){const t=this;return new Promise((n,i)=>{CONST.draw("circle",t.context,e).then(e=>{t.options=e,t.options.shapeMinX=t.options.cx-t.options.r,n()}).catch(e=>{i(e)})})}compareTo(e=null){return _.compareXY(this.options.shapeMinX,e.options.shapeMinX)}comparePointX(e=null){return _.compareXY(this.options.shapeMinX,e.x)}hasPoint(e=null){return CONST.containPoint("circle",e,this.options)}}class Rectangle extends ShapeBase{constructor(e,t){super(e,t)}draw(e={}){const t=this;return new Promise((n,i)=>{CONST.draw("rectangle",t.context,e).then(e=>{t.options=e,t.options.shapeMinX=t.options.x,n()}).catch(e=>{i(e)})})}compareTo(e=null){return _.compareXY(this.options.shapeMinX,e.options.shapeMinX)}comparePointX(e=null){return _.compareXY(this.options.shapeMinX,e.options.shapeMinX)}hasPoint(e=null){return CONST.containPoint("rectangle",e,this.options)}}class PolygonXYs extends ShapeBase{constructor(e,t){super(e,t)}draw(e={}){const t=this;return new Promise((n,i)=>{CONST.draw("polygonXYs",t.context,e).then(e=>{t.options=e,t.options.shapeMinX=t.options.cx-t.options.r,n()}).catch(e=>{i(e)})})}}const Shape={Circle:Circle,Rectangle:Rectangle,PolygonXYs:PolygonXYs},_evtList=["click","mousemove","mouseover","mouseout","contextmenu"],Draw={_draw:async(e=null,t=null,n={})=>{const{eventObj:i={},opts:s={}}=n,{shapeOrigin:a=""}=s,{scope:r="",events:o={}}=i;let l=null;switch(a){case"circle":l=new Shape.Circle(e,t);break;case"rectangle":s.rBorder=0,l=new Shape.Rectangle(e,t);break;case"round-rectangle":l=new Shape.Rectangle(e,t)}l&&await l.draw(s).then(()=>{r&&_evtList.forEach(e=>{l.addListener(r,e,o[e])})})},shape:async(e=null,t=null,n=null)=>{await Draw._draw(e,t,n)},shapeHighlight:async(e=null,t=null,n=null)=>{const{fillOpts:i=null,strokeOpts:s=null}=n;i&&await Draw._draw(e,t,{opts:i}),s&&await Draw._draw(e,t,{opts:s})},shapeHover:async(e=null,t=null,n=null)=>{await Draw._draw(e,t,{opts:n})}};class FENode{constructor(e=""){this.scope=e,this.id=null,this.text="",this.shape="",this.siblingsWidth=null,this.stepWidth=0,this.maxY=null,this.path=null,this.attachInfo=null,this.children=[],this.hasChildren,this.first=null,this.last=null,this.parent=null,this.next=null,this.previous=null,this.siblingsIndex=null,this.x=null,this.y=null}setParentSiblings(e=null,t=null){if(this.parent=t,this.hasChildren=this.children&&this.children.length>0,this.siblingsIndex=e,this.hasChildren){const e=this.children.length;this.first=this.children[0],this.last=this.children[e-1];for(let t=0;t<e-1;t++)this.children[t].next=this.children[t+1];for(let t=1;t<e;t++)this.children[t].previous=this.children[t-1];for(let t=0;t<e;t++)this.children[t].setParentSiblings(t,this)}}setPath(){const e=u._getTargetPath(this);if(this.path="",this.attachInfo=null,e&&e.length){const t=e.length;e.forEach(e=>{this.path+=`.children[${e}]`}),this.path&&(this.path=this.path.substr(1)),this.attachInfo={parentPath:"",index:null},e.forEach((e,n)=>{n<t-1?this.attachInfo.parentPath+=`.children[${e}]`:n===t-1&&(this.attachInfo.index=e)}),this.attachInfo.parentPath&&(this.attachInfo.parentPath=this.attachInfo.parentPath.substr(1))}if(this.hasChildren){const e=this.children.length;for(let t=0;t<e;t++)this.children[t].setPath()}}setHorizontalWidth(e=1,t={}){const{styles:n}=t,{size:i,gutter:s}=n,{width:a,height:r}=i,o=a*e,l=r*e,h=s.horizontal*e;this.width=o,this.height=l;for(let n=this.first;null!==n;n=n.next)n.setHorizontalWidth(e,t);if(!this.hasChildren)return this.leftWidth=o/2,void(this.rightWidth=o/2);for(let e=this.first;null!==e&&null!==e.next;e=e.next){const t=e.rightWidth+h/2+e.next.leftWidth;this.stepWidth=Math.max(this.stepWidth,t)}if(this.leftWidth=0,this.rightWidth=0,this.hasChildren){const e=this.children.length-1;this.siblingsWidth=e*this.stepWidth,this.leftWidth=this.siblingsWidth/2+this.first.leftWidth,this.rightWidth=this.siblingsWidth/2+this.last.rightWidth}this.leftWidth=Math.max(this.leftWidth,o/2+h/2),this.rightWidth=Math.max(this.rightWidth,o/2+h/2)}adjustHeight(){this.maxY=this.y;for(let e=this.first;null!==e;e=e.next)this.maxY=Math.max(this.maxY,e.adjustHeight());return this.maxY}assignLocation(e=0,t=0,n=1,i={}){const{__boundaryPoint:s,styles:a}=i,{gutter:r}=a;if(s.x.min=Math.min(s.x.min,e),s.x.max=Math.max(s.x.max,e),s.y.min=Math.min(s.y.min,t),s.y.max=Math.max(s.y.max,t),this.x=Math.floor(e)+.5,this.y=Math.floor(t)+.5,this.hasChildren){const s=this.children.length,a=e-this.siblingsWidth/2;for(let e=0;e<s;e++){const s=a+e*this.stepWidth,o=t+this.height+r.vertical*n/2;this.children[e].assignLocation(s,o,n,i)}}}collectBaseDataOfShape(e={},t=""){const{scaleRatio:n,styles:i}=e,{shape:s}=i,{_shape:a,_shapeOrigin:r}=u.getShapeAndShapeOrigin(this),o=_.get(s,`${a}.bg`)||_.get(s,`${r}.bg`),l=_.get(s,`${a}.bgImg`)||_.get(s,`${r}.bgImg`),h=_.get(s,`${a}.rBorder`)||_.get(s,`${r}.rBorder`)||2,c={scaleRatio:n,shapeOrigin:r,x:this.x-this.width/2,y:this.y,w:this.width,h:this.height,bgImg:l,rBorder:h,data:this};return"fill"===t?_.merge(c,{type:t,fillColor:o}):"stroke"===t&&_.merge(c,{type:t,strokeColor:o}),c}async _drawShape(e=null,t=null,n={}){const i={opts:this.collectBaseDataOfShape(n,"fill"),eventObj:{scope:this.scope,events:n.events}};await Draw.shape(e,t,i)}async _drawShapeHighlight(e=null,t=null,n={}){const i=_.get(this,"highlight.type"),s=u.collectHighlightDataOfShape(i,this,n);s&&await Draw.shapeHighlight(e,t,s)}_fillText(e=null,t=null,n={}){const{scaleRatio:i,styles:s}=n,{shape:a}=s,r=_.get(this,"shape"),o=r.split("__")[0],l=_.get(a,`${r}.text.family`)||_.get(a,`${o}.text.family`),h=_.get(a,`${r}.text.size`)||_.get(a,`${o}.text.size`),c=_.get(a,`${r}.text.lineHeight`)||_.get(a,`${o}.text.lineHeight`);let d=(_.get(a,`${r}.text.indent`)||_.get(a,`${o}.text.indent`))*i;const u=_.get(a,`${r}.text.maxLen`)||_.get(a,`${o}.text.maxLen`),g=`${h*i}px/${c*i}px ${l}`,p=(this.text||"").length>u?`${this.text.substr(0,u)}..`:this.text,m=_.get(a,`${r}.text.color`)||_.get(a,`${o}.text.color`),f=_.get(a,`${r}.text.align`)||_.get(a,`${o}.text.align`);t.font=g,t.textBaseline="middle",t.fillStyle=m,t.textAlign=f,"center"===t.textAlign&&(d=this.width/2),t.fillText(p,this.x-this.width/2+d,this.y+this.height/2)}_drawLine(e=null,t=null,n={}){const{scaleRatio:i,styles:s}=n,{line:a}=s,r=_.get(a,"color","#000"),o=_.get(a,"width",1)*i,l=_.get(a,"borderRadius",6)*i,h=this.parent.x,c=this.parent.y+this.parent.height,d=this.x,u=this.y,g=h,p=c+(u-c)/2,m=h>d?d+l:h<d?d-l:d,f=p,v=d,y=p+l;t.beginPath(),t.lineWidth=o,t.strokeStyle=r;const w=4*o,x=1.5*w;t.moveTo(h,c),t.lineTo(g,p),t.lineTo(m,f),t.quadraticCurveTo(d,f,v,y),t.lineTo(d,u),t.stroke();const C={x:d-w,y:u-x,w:2*w,h:x,type:"fill",fillColor:r,polygonXYsArr:[{x:d-w,y:u-x},{x:d+w,y:u-x},{x:d,y:u}]};new Shape.PolygonXYs(e,t).draw(C)}async draw(e=null,t=null,n={}){await this._drawShape(e,t,n),await this._drawShapeHighlight(e,t,n),await this._fillText(e,t,n);for(let i=this.first;null!==i;i=i.next)await i.draw(e,t,n);this.parent&&await this._drawLine(e,t,n)}translateX(e=1,t=0){t+Config.padding*e<=0||this._doTranslateX(t)}_doTranslateX(e=0){if(this.x+=e,this.hasChildren){const t=this.children.length;for(let n=0;n<t;n++)this.children[n]._doTranslateX(e)}}}const FEParse={parse:(e="",t=null)=>{var n=new FENode(e);return Object.keys(t).forEach(e=>{"children"!==e&&(n[e]=t[e])}),FEParse.hasChildren(t)&&(n.children=[],t.children.forEach(t=>{n.children.push(FEParse.parse(e,t))})),n},hasChildren:e=>e.children&&e.children.length};class Event{constructor(e=-1,t=-1,n=null,i=null){this.x=e,this.y=t,this.type=n,this.target=i}}const C={domEl:"j-class-drag-scroll",_window:window,mousemove:"mousemove",mouseup:"mouseup",mousedown:"mousedown",addEventListener:"addEventListener",removeEventListener:"removeEventListener",dragged:[],cancel:!1,noop(){},reset(e=0,t=null){for(e=0;e<C.dragged.length;)(t=C.dragged[e++])[C.removeEventListener](C.mousedown,t.md,0),C._window[C.removeEventListener](C.mouseup,t.mu,0),C._window[C.removeEventListener](C.mousemove,t.mm,0);if(!C.cancel)for(C.dragged=document.getElementsByClassName(C.domEl),e=0;e<C.dragged.length;)((e=null,t=0,n=0,i=0)=>{e[C.addEventListener](C.mousedown,e.md=((e=null)=>{i=1,t=e.clientX,n=e.clientY,e.preventDefault(),e.stopPropagation()}),!1),C._window[C.addEventListener](C.mouseup,e.mu=(()=>{i=0}),!1),C._window[C.addEventListener](C.mousemove,e.mm=((s=null,a=null)=>{a=e.scroller||e,i&&(a.scrollLeft-=-t+(t=s.clientX),a.scrollTop-=-n+(n=s.clientY))}),!1)})(C.dragged[e++])}},DragScroll={dragScroll:(e={})=>{const{cancel:t=!1}=e;C.cancel=t,C._window[C.addEventListener]("load",C.reset,!1),C.reset()}};class MainCanvas{constructor(){this.scope="scope",this.wrapSize=null,this.realSize=null,this.finalWidth=null,this.finalHeight=null,this.optWrapDomEle=null,this.domObj=null,this.idPrefix="j-fe-canvas",this.canvas=null,this.context=null,this.cId=`${this.idPrefix}`,this.cZIndex=1,this.canvasHover=null,this.contextHover=null,this.cIdHover=`${this.idPrefix}-hover`,this.cZIndexHover=2,this.canvasActive=null,this.contextActive=null,this.cIdActive=`${this.idPrefix}-active`,this.cZIndexActive=3,this.renderRatio=1,this.jsonView=null,this.options=Config.originOptions(),this.selectedFENodes=[],this.scale={ratio:1,min:.5,max:3},this.clickEvtFlag=!1,this.contextmenuEvtFlag=!1,this.mouseEvtFlag=!1}_setUniqueId(e=""){this[`cId${e}`]=u._addUniqueSuffix(this[`cId${e}`])}_setScopeUnique(){this.scope=u._addUniqueSuffix(this.scope)}_resetSomeData(){this.selectedFENodes.splice(0,this.selectedFENodes.length)}_setScale(e=1){this.scale.ratio=e}setWrapSize(){const{domEleSizeNumber:e={}}=this.domObj;this.wrapSize=_.deepClone(e)}setOrigin(){this.options.__originPoint.x=this.wrapSize.width/2,this.options.__originPoint.y=Config.padding}_filterValidCanvas(e=""){return _.arrayContainsVal(Config.canvasList,e)}_createSingleCanvas(e=""){const t=this.wrapSize,n=Config.canvasList[0].length;if(!this._filterValidCanvas(e))return;const i=e.substr(n),s=`context${i}`;this[e]=dom.create("canvas");const a=this[e];this[s]=a.getContext("2d");const r=this[s],o=this.renderRatio=_.getPixelRatio(r),l=this.realSize={width:t.width/o,height:t.height/o};a.style.width=`${l.width}px`,a.style.height=`${l.height}px`,a.width=t.width*o,a.height=t.height*o,this._setUniqueId(i),a.id=this[`cId${i}`],a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.zIndex=this[`cZIndex${i}`],i&&(a.style.pointerEvents="none")}_setSingleCanvasStyle(e="",t=1,n={}){if(!this._filterValidCanvas(e))return;const i=this[e],{w:s,h:a}=n;i.style.width=`${s}px`,i.style.height=`${a}px`,i.width=s*t,i.height=a*t}createCanvasCtx(){const e=this;try{e.setWrapSize(),e.setOrigin(),Config.canvasList.forEach(t=>{e._createSingleCanvas(t)})}catch(e){throw"canvas"}}create(e={}){const{domObj:t,data:n,options:i}=e;return this.domObj=_.deepClone(t),_.merge(this.options,i),_.merge(this.options,Config.privateOriginPoint()),_.merge(this.options,Config.privateBoundaryPoint()),this._setScopeUnique(),this.createCanvasCtx(),this.calcLayoutDrawInCanvas(n)}update(e={}){return _.merge(this.options,Config.privateBoundaryPoint()),this.calcLayoutDrawInCanvas(e)}initLayout(){const e=this.jsonView,t=this.options,n=t.__originPoint,i=this.scale.ratio;e.setParentSiblings(),e.setPath(),e.setHorizontalWidth(i,t),e.assignLocation(n.x,n.y*i,i,t),e.adjustHeight()}setFinalSize(){const e=this.jsonView,t=this.scale.ratio;this.finalWidth=e.leftWidth+e.rightWidth+2*Config.padding*t+2*Config.hiddenWidth/3,this.finalHeight=e.maxY+3*Config.padding*t+2*Config.hiddenWidth/3}calcLayoutDrawInCanvas(e={}){const t=this;t._resetSomeData(),t.jsonView=FEParse.parse(t.scope,e),_.merge(t.options,{scaleRatio:t.scale.ratio});const n=t.jsonView,i=t.options,{__boundaryPoint:s}=i;t.initLayout(),t.setFinalSize();const a=t.canvas,r=t.context,o=t.renderRatio,l=t.wrapSize,h={w:Math.max(l.width,t.finalWidth,s.x.max-s.x.min),h:Math.max(l.height,t.finalHeight,s.y.max-s.y.min)};Config.canvasList.forEach(e=>{t._setSingleCanvasStyle(e,o,h)});const c=Math.floor(n.leftWidth+Config.padding*t.scale.ratio)-l.width/2;n.translateX(t.scale.ratio,c),r.scale(o,o),n.draw(a,r,i),EventManager$1._targets={};const d=[];return Config.canvasList.forEach(e=>{d.push(t[e])}),{res:d,options:i}}enableClick(){const e=this,t=e.canvas;e.clickEvtFlag=!0,t.addEventListener("click",t=>{e._handleClick("click",t,e)},!1)}_handleClick(e="",t=null,n=null){this._handleEvt({type:e,event:t,target:n})}enableMouse(){const e=this,t=e.canvas;e.mouseEvtFlag=!0,t.addEventListener("mousemove",t=>{e._handleMouse("mousemove",t,e)},!1),t.addEventListener("mouseover",t=>{e._handleMouse("mouseover",t,e)},!1),t.addEventListener("mouseout",t=>{e._handleMouse("mouseout",t,e)},!1)}_handleMouse(e="",t=null,n=null){this._handleEvt({type:e,event:t,target:n})}enableContextmenu(){const e=this,t=e.canvas;e.contextmenuEvtFlag=!0,t.addEventListener("contextmenu",t=>{t.preventDefault(),e._handleContextmenu("contextmenu",t,e)},!1)}_handleContextmenu(e="",t=null,n=null){this._handleEvt({type:e,event:t,target:n})}_handleEvt(e={}){const t=this,{type:n="",event:i=null,target:s=null,canvasPoint:a=null}=e,r=a&&"object"===_.typeOf(a),o=r?a:s._windowToCanvas(i.clientX,i.clientY),l=r?"simulation":"trigger",h=0===n.indexOf("mouse"),c=h?"mouse":n,d=EventManager$1.getTargets(c);if(null===d)"clickEmpty"===n&&t._handleNoTargets({type:n,event:i,point:o,eventFrom:l});else{d.search(o);const e=_.get(d,"selectedElements",[]),a=_.get(d,"unSelectedElements",[]);e.length?e.forEach(e=>{h?(t._listenerFire({type:"mousemove",event:i,target:s,ele:e,point:o,eventFrom:l}),e.inBounds||(e.inBounds=!0,t._listenerFire({type:"mouseover",event:i,target:s,ele:e,point:o,eventFrom:l}))):("contextmenu"===n&&(dom.disabledMouseWheel({domEle:t.optWrapDomEle}),DragScroll.dragScroll({cancel:!0})),t._listenerFire({type:n,event:i,target:s,ele:e,point:o,eventFrom:l}))}):("click"===n&&t._handleNoTargets({type:"clickEmpty",event:i,point:o,eventFrom:l}),"contextmenu"===n&&t._handleNoTargets({type:"contextmenuEmpty",event:i,point:o,eventFrom:l})),h&&a.length&&a.forEach(e=>{e.inBounds&&(e.inBounds=!1,t._listenerFire({type:"mouseout",event:i,target:s,ele:e,point:o,eventFrom:l}))})}}_listenerFire(e={}){const t=this,{type:n="",event:i=null,target:s=null,ele:a=null,point:r=null,eventFrom:o=""}=e;if(a.hasListener(t.scope,n)){const l=new Event(r.x,r.y,n,a);"click"!==n&&"contextmenu"!==n||t._doClickDraw(e),"mouseover"===n&&t._doHoverDraw(e),"mouseout"===n&&t._doHoverDraw(),s.canvas.style.cursor="mouseout"===n?"":"default";const h={scope:t.scope,type:n,FENodeEvent:l,attach:{event:i,target:s},eventFrom:o},c=a.fire(h)||[];"click"!==n&&"contextmenu"!==n||(t.selectedFENodes.splice(0,t.selectedFENodes.length),c.length&&c.forEach(e=>{t.selectedFENodes.push(e)}))}}_doClickDraw(e=null){this._doHighlightDraw("active",e)}_doHoverDraw(e=null){this._doHighlightDraw("hover",e)}async _doHighlightDraw(e="",t=null){const n=this;if(!e||!_.arrayContainsVal(["hover","active"],e))return;const i=`${e.substring(0,1).toUpperCase()}${e.substring(1)}`;if(n[`_clearCav${i}`](),t){const s=_.get(t,"target.options",{}),a=_.get(t,"ele.options.data",{}),r=u.collectHighlightDataOfShape(e,a,s),o=n[`canvas${i}`],l=n[`context${i}`];l.scale(n.renderRatio,n.renderRatio),r&&await Draw.shapeHighlight(o,l,r)}}_windowToCanvas(e=0,t=0){const n=this.canvas.getBoundingClientRect();return{x:e-n.left,y:t-n.top}}_handleNoTargets(e){const t=this,{type:n="",event:i=null,point:s=null}=e;if(dom.disabledMouseWheel({domEle:t.optWrapDomEle,flag:!1}),DragScroll.dragScroll(),t._clearCavActive(),t.selectedFENodes.splice(0,t.selectedFENodes.length),t.clickEvtFlag||t.contextmenuEvtFlag||t.mouseEvtFlag){const e=_.get(t,"options.events.clickEmpty",null);e&&"function"===_.typeOf(e)&&e.call(t,{type:"clickEmpty",target:null,targetPath:null,targetAttach:null,event:i,shapePoint:null})}}_clearCavActive(){this.canvasActive.height=this.canvasActive.height}_clearCavHover(){this.canvasHover.height=this.canvasHover.height}}const HELPS={_create2ImageCvs(e=null){const t=dom.create("canvas"),n=t.getContext("2d");return t.width=e.width,t.height=e.height,t.style.width=e.style.width,t.style.height=e.style.height,{cvsImg:t,ctxImg:n}},_checkBeforeDoAfterCreateAction(e=null){const t=_.get(e,"cacheFE.create",{}),n=t.el&&t.options&&t.mainCanvas;if(!n)throw new Error(u._makeConsoleStr(["Project FlowEditor does not exist! Create the canvas first.","You may need: `const flowEditor = new FlowEditor()`","and call method: `flowEditor.create(conf)` create."]));return n},_beforeMergeCanvasLayer:(e={},t={})=>new Promise((n,i)=>{const{withBg:s=!0,type:a="png",base64:r=!0}=e,{cvsImg:o,ctxImg:l,createOptions:h}=t,c=_.get(h,"styles.canvas",{}),d={type:"image/",base64:r};if("jpg"===a&&(d.type+="jpeg"),s){const e=(e,t)=>{l.fillStyle=e,l.fillRect(0,0,o.width,o.width),t(d)};if(c.bgImg){const t=u.createCrossOriginImage(c.bgImg);t.onload=(()=>{e(l.createPattern(t,"repeat"),n)})}else e(c.bg,n)}else n(d)})};class FlowEditor{constructor(){this.originData={css:{position:"absolute",left:"0",top:"0",right:`-${Config.hiddenWidth}px`,bottom:`-${Config.hiddenWidth}px`,overflow:"scroll",background:"transparent"},outerWrapId:"j-fe-canvas-outer-wrap",outerWrapClassName:"class-fe-canvas-outer-wrap",wrapId:"j-fe-canvas-inner-wrap",wrapClassName:"class-fe-canvas-inner-wrap"},this.cacheFE={cvsArr:[],innerDomEle:null,create:{el:null,options:null,eventBind:null,domEle:null,domEleStyles:null,sizeStyle:null,sizeStyleNumber:null,outerStyle:{position:"relative",overflow:"hidden"},baseStyle:{},createOptions:{}}},this.selectedFENodes=null}create(e={}){try{const t=this,{el:n="",data:i={},options:s={}}=e,a=t.cacheFE,r=t.cacheFE.create,{click:o=!1,contextmenu:l=!1,mouse:h=!1}=_.get(s,"eventBind",{});r.el=n,r.data=_.deepClone(i),r.options=s,r.domEle=dom.$(n),r.domEleStyles=window.getComputedStyle(r.domEle,null),r.eventBind={click:o,contextmenu:l,mouse:h},r.sizeStyle={width:r.domEleStyles.width,height:r.domEleStyles.height};const{width:c,height:d}=r.sizeStyle;r.sizeStyleNumber={width:Number(_.removeSuffix(c,"px")),height:Number(_.removeSuffix(d,"px"))},a.innerDomEle=null,a.innerDomEle=dom.create("div");const g=a.innerDomEle,p=t.originData;p.wrapId=u._addUniqueSuffix(p.wrapId),p.wrapClassName=u._addUniqueSuffix(p.wrapClassName),p.outerWrapId=u._addUniqueSuffix(p.outerWrapId),p.outerWrapClassName=u._addUniqueSuffix(p.outerWrapClassName);const{css:m,wrapId:f,wrapClassName:v,outerWrapId:y,outerWrapClassName:w}=t.originData;g.id=f,g.className+=`${v} j-class-drag-scroll`,r.mainCanvas=new MainCanvas;const x={domObj:{domEle:r.domEle,domEleSizeNumber:r.sizeStyleNumber},data:i,options:s},C=r.mainCanvas.create(x);a.cvsArr=_.get(C,"res",[]),r.createOptions=_.get(C,"options",{});const{canvas:E}=r.createOptions.styles;r.outerStyle.background=E.bgImg?`url(${E.bgImg})`:`${E.bg||"#fff"}`,_.merge(r.outerStyle,r.sizeStyle),_.merge(r.baseStyle,m);const S=dom.create("div");S.id=y,S.className+=w;const b=`\n                ${View.createStyleStr(w,r.outerStyle)}\n                ${View.createStyleStr(v,r.baseStyle)}\n                ${View.getCustomScrollbarStyle(v)}\n                ${View.getDraggGrabStyle(v)}\n            `;dom.createStyle(b),o&&r.mainCanvas.enableClick(),l&&r.mainCanvas.enableContextmenu(),h&&r.mainCanvas.enableMouse(),a.cvsArr.forEach(e=>{dom.inject(e,g)}),DragScroll.dragScroll(),dom.html(r.domEle,""),dom.inject(g,S),dom.inject(S,r.domEle),r.mainCanvas.optWrapDomEle=S,t.selectedFENodes=r.mainCanvas.selectedFENodes}catch(e){throw"canvas"===e&&dom.text("Your browser does not support the Canvas HTML element."),new Error(e)}return!1}update(e={}){const t=this;if(HELPS._checkBeforeDoAfterCreateAction(t)){const n=_.get(t,"cacheFE.create",{});n.data=null,n.data=_.deepClone(e),n.mainCanvas.update(e)}}setSelected(e=""){const t=this;if(HELPS._checkBeforeDoAfterCreateAction(t)){const n=_.get(t,"cacheFE.create",{}),i=_.get(n.mainCanvas.jsonView,`${e}`,null);if(!i)throw new Error(u._makeConsoleStr([`FENode path does't exist: ${e} .Please check it.`]));const s={type:"click",canvasPoint:{x:i.x+1,y:i.y+1},target:n.mainCanvas};setTimeout(()=>{n.mainCanvas._handleEvt(s)},Config.DELAY.simulateClick)}}setUnSelected(){const e=this;if(HELPS._checkBeforeDoAfterCreateAction(e)){const t=_.get(e,"cacheFE.create",{}),n={type:"clickEmpty",canvasPoint:{x:-1,y:-1},target:t.mainCanvas};setTimeout(()=>{t.mainCanvas._handleEvt(n)},Config.DELAY.simulateClick)}}scale(e=1){const t=this;if(HELPS._checkBeforeDoAfterCreateAction(t)){const n=_.get(t,"cacheFE.create",{}),i=n.mainCanvas;e&&"number"===_.typeOf(e)&&i.scale.min<=e&&e<=i.scale.max&&(i._setScale(e),i.update(n.data))}}find(e={},t="",n=""){return _.get(e,t,n)}getImage(e={}){const t=this;return new Promise((n,i)=>{if(HELPS._checkBeforeDoAfterCreateAction(t)){const i=_.get(t,"cacheFE.create.createOptions",{}),s=_.get(t,"cacheFE.cvsArr",[]),a=s[0],{cvsImg:r,ctxImg:o}=HELPS._create2ImageCvs(a),l={cvsImg:r,ctxImg:o,createOptions:i};HELPS._beforeMergeCanvasLayer(e,l).then((e={})=>{s.forEach(e=>{o.drawImage(e,0,0,r.width,r.height)});const t=r.toDataURL(e.type);if(e.base64)n(t);else{const e=dom.create("a"),n=new MouseEvent("click");e.download="flow-editor-pro",e.href=t,e.dispatchEvent(n)}})}else i()})}}module.exports=FlowEditor;
