!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.FlowEditor=t()}(this,function(){"use strict";const e={typeOf:e=>null===e?String(e):{}.toString.call(e).slice(8,-1).toLowerCase(),merge:(t={},n={})=>{const i=e.typeOf(t),s=e.typeOf(n);if(i!==s)return n;switch(s){case"object":for(let i in n)n.hasOwnProperty(i)&&(t[i]=e.merge(t[i],n[i]));break;case"array":for(let i=0;i<n.length;i++)t[i]=e.merge(t[i],n[i]);t.length=n.length;break;default:return n}return t},deepClone:t=>{const n=t=>{let s,a,r={};for(let l in t)s=t[l],a=e.typeOf(s),r[l]="object"===a?n(s):"array"===a?i(s):s;return r},i=t=>{let s,a,r=[];for(let l=0;l<t.length;l++)s=t[l],"object"===(a=e.typeOf(s))?r[l]=n(s):"array"===a?r[l]=i(s):"object"!=typeof s&&(r[l]=s);return r};switch(e.typeOf(t)){case"object":return n(t);case"array":return i(t);default:return t}},get:(t={},n="",i="")=>{if(""===n)return t;return("array"===e.typeOf(n)?n:n.replace(/\[/g,".").replace(/'|"|\]/g,"").split(".")).reduce((e,t)=>(e||{})[t],t)||i},deepGet:(t={},n="",i="")=>e.deepClone(e.get(t,n,i)),compareXY:(t=0,n=0)=>"number"!==e.typeOf(t)||"number"!==e.typeOf(n)?null:t<n?-1:t===n?0:t>n?1:void 0,arrayContainsVal:(e=[],t="")=>void 0!==e&&null!==e&&void 0!==t&&null!==t&&-1!==e.indexOf(t),getPixelRatio:(e=null)=>{if(!e)return null;const t=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/t},removeSuffix:(t="",n="")=>"string"!==e.typeOf(t)&&"string"!==e.typeOf(n)?t:t&&n?t.length<=n.length?t:t.substr(0,t.length-n.length):t},t={_getTargetPath:(e=null)=>{const t=[],n=(e=null)=>{if(!e)return null;e.parent&&(t.unshift(e.siblingsIndex),n(e.parent))};return n(e),t},_addUniqueSuffix:(e="")=>{return`${e}${`-${+Date.now()}-${parseInt(1e4*Math.random())}`}`},_makeConsoleStr:(t=[])=>{if(!t||"array"!==e.typeOf(t)||!t.length)return null;let n="\n";return t.forEach(e=>{n+=`\n\t\t${e}`}),`${n}\n`},getShapeAndShapeOrigin:(t=null)=>{const n=e.get(t,"shape");return{_shape:n,_shapeOrigin:n.split("__")[0]}},collectHighlightDataOfShape:(n="",i=null,s=null)=>{const{scaleRatio:a,styles:r}=s,{shape:l}=r,{_shape:o,_shapeOrigin:h}=t.getShapeAndShapeOrigin(i),c={};if(e.merge(c,e.get(l,`${o}.highlight`,null)),e.merge(c,e.get(l,`${h}.highlight`,null)),n&&c){let t=null;const s=e.get(c,`${n}.bg`),r=e.get(l,`${o}.rBorder`)||e.get(l,`${h}.rBorder`),d=e.get(c,`${n}.border`);if(d){const e=d.split(" ");if(e&&e.length>=2){const n=e[0];e[1];t={type:"stroke",strokeColor:e.filter((e,t)=>t>1).join(" "),lineWidth:parseInt(n)}}}const u={scaleRatio:a,shapeOrigin:h,x:i.x-i.width/2,y:i.y,w:i.width,h:i.height,rBorder:r},g={type:"fill",fillColor:s};return{fillOpts:e.merge(g,u),strokeOpts:null===t?null:e.merge(t,u)}}return null},createCrossOriginImage:(e="")=>{const t=new Image;return t.setAttribute("crossOrigin","Anonymous"),t.src=e,t}},n={};n.msie=parseInt((/msie (\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1]),isNaN(n.msie)&&(n.msie=parseInt((/trident\/.*; rv:(\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1])),n.$=((e="")=>{if(document.querySelector)try{return document.querySelector(e)}catch(e){throw new Error(e)}if(-1!==e.indexOf("#"))return document.getElementById(e.slice(1))}),n.text=function(){const e={};return n.msie&&n.msie<9?(e[1]="innerText",e[3]="nodeValue"):e[1]=e[3]="textContent",function(t,n){let i=e[t.nodeType];if(null===n)return i?t[i]:"";t[i]=n}}(),n.html=((t=null,n="")=>{if("undefined"===e.typeOf(n))return t.innerHTML;t.innerHTML=n}),n.create=((e="")=>e?document.createElement(e):null),n.inject=((e=null,t=null)=>{if(!e)return null;if(Array.isArray(e)){let t=e;e=n.fragment();for(let n=0,i=t.length;n<i;n++)e.appendChild(t[n])}t.appendChild(e)}),n.createStyle=((e="")=>{const t=n.create("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e));const i=n.$("head");i&&i.appendChild(t)}),n.disabledMouseWheel=((e={})=>{const{domEle:t=document,flag:n=!0}=e,i=n?()=>!1:()=>!0;document.addEventListener&&t.addEventListener("DOMMouseScroll",i,!1),t.onmousewheel=i});const i={DELAY:{simulateClick:400},padding:20,hiddenWidth:18,canvasList:["canvas","canvasHover","canvasActive"],originText:()=>{return{family:"Arial",color:"#fff",size:12,lineHeight:12,align:"center",indent:0,maxLen:10}},originHighlight:(e="")=>{return{error:{bg:"rgba(255, 51, 51, .2)",border:"1px solid rgba(255, 51, 51, 1)",rBorder:2},hover:{bg:"rgba(255, 255, 255, 0)",border:"1px solid rgba(51, 126, 255, 1)",rBorder:2},active:{bg:"rgba(26, 110, 255, .2)",border:"1px solid rgba(51, 126, 255, 1)",rBorder:2}}[e]||null},_shapeNormalConf:(t=null)=>{const n={bg:"#4caf50",highlight:{hover:i.originHighlight("hover"),active:i.originHighlight("active"),error:i.originHighlight("error")},text:i.originText()};return t&&e.merge(n,t),n},privateOriginPoint:()=>({__originPoint:{x:0,y:0}}),privateBoundaryPoint:()=>({__boundaryPoint:{x:{min:0,max:0},y:{min:0,max:0}}}),originOptions:()=>{return{styles:{canvas:{bg:"#fff",bgImg:""},size:{width:120,height:36},gutter:{vertical:100,horizontal:60},shape:{circle:i._shapeNormalConf(),rectangle:i._shapeNormalConf(),"round-rectangle":i._shapeNormalConf({rBorder:2}),rhombus:i._shapeNormalConf(),ellipse:i._shapeNormalConf(),triangle:i._shapeNormalConf()},line:{color:"#61afef",width:1,borderRadius:6}},eventBind:{click:!1,contextmenu:!1,mouse:!1},events:{click(){},contextmenu(){},mousemove(){},mouseover(){},mouseout(){},clickEmpty(){}}}}},s={getCustomScrollbarStyle:(e="")=>{let t="";return e&&(t=`\n            .${e}::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n            .${e}::-webkit-scrollbar-thumb {\n                background: #ccc;\n                border-radius: 4px;\n                transition: background .3s;\n            }\n            .${e}::-webkit-scrollbar-track-piece {\n                background-color: rgba(255, 255, 255, 0);\n                border-radius: 4px;\n            }\n            .${e}::-webkit-scrollbar-thumb:vertical:hover {\n                background: #a0a0a0;\n            }\n            .${e}::-webkit-scrollbar-thumb:horizontal:hover {\n                background: #a0a0a0;\n            }\n        `),t},createStyleStr:(e="",t=null)=>{let n="";if(e&&t){let i="";Object.keys(t).forEach(e=>{i+=`\n                ${e}: ${t[e]};\n            `}),n=`\n            .${e} {\n                ${i}\n            }\n        `}return n},getDraggGrabStyle:(e="")=>{let t="";return e&&(t=`\n            .${e} {\n                cursor: grab;\n            }\n            .${e}:active {\n                cursor : grabbing;\n            }\n        `),t}},a={};a.PI2=2*Math.PI,a.getShapeOptions=((e={})=>{const{x:t,y:n,w:i,h:s}=e;return e.cx=t+i/2,e.cy=n+s/2,e.w2=i/2,e.h2=s/2,e.r=Math.min(e.w2,e.h2),e}),a.draw=((e="",n=null,i={})=>new Promise((s,r)=>{const l=a.getShapeOptions(i),{scaleRatio:o=1,x:h=-1,y:c=-1,cx:d=0,cy:u=0,w:g=0,h:p=0,w2:m=0,h2:f=0,r:v=0,lineWidth:y=1,type:x="",fillColor:w="",strokeColor:b="",bgImg:_="",rBorder:E=2,polygon:C=null,polygonXYsArr:S=null}=l;n.beginPath(),n.shadowBlur=10*o,n.shadowColor="rgba(0, 0, 0, .1)",n.shadowOffsetX=2*o,n.shadowOffsetY=2*o;const k=E*o;switch(e){case"circle":n.arc(d,u,v,0,a.PI2);break;case"rectangle":n.moveTo(h,c+k),n.lineTo(h,c+p-k),n.quadraticCurveTo(h,c+p,h+k,c+p),n.lineTo(h+g-k,c+p),n.quadraticCurveTo(h+g,c+p,h+g,c+p-k),n.lineTo(h+g,c+k),n.quadraticCurveTo(h+g,c,h+g-k,c),n.lineTo(h+k,c),n.quadraticCurveTo(h,c,h,c+k);break;case"polygonXYs":{const e=S;n.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)n.lineTo(e[t].x,e[t].y);break}}if("stroke"===x&&(n.lineWidth=y*o),_){const e=t.createCrossOriginImage(_);e.onload=(()=>{n.closePath(),n.drawImage(e,h,c,g,p),n.shadowBlur=0,n.shadowColor=null,n.shadowOffsetX=0,n.shadowOffsetY=0,s(l)})}else n[`${x}Style`]=i[`${x}Color`],n.closePath(),n[x](),n.shadowBlur=0,n.shadowColor=null,n.shadowOffsetX=0,n.shadowOffsetY=0,s(l)})),a.containPoint=((e="",t=null,n={})=>{const{x:i,y:s}=t,{x:a,y:r,cx:l,cy:o,w:h,h:c,r:d}=n;if(null===i||null===s)return!1;let u=!1;switch(e){case"circle":u=Math.pow(i-l,2)+Math.pow(s-o,2)-Math.pow(d,2)<=0;break;case"rectangle":u=i<=a+h&&s<=r+c&&i>=a&&s>=r;break}return{flag:u,loc:{x:a-i,y:r-s}}});class r{constructor(){this._data=[],this.selectedElements=[],this.unSelectedElements=[]}add(e=null){if(!e)return;const t=this._data,n=t.length;let i=0;for(let s=0;s<n;s++){const n=t[s],a=e.compareTo(n);if(null===a)return;if(!(a>0))break;i++}for(let e=n;e>i;e--)t[e]=t[e-1];t[i]=e}contains(e=null){if(null==e)return!1;const t=this._data;let n=t.length-1,i=0,s=null;for(;i<=n;){if(t[s=parseInt((i+n)/2)]===e)return!0;t[s].compareTo(e)<0?i=s+1:n=s-1}return!1}search(e=null){const t=this,n=t._data,i=n.length;let s=null;t.selectedElements.length=0,t.unSelectedElements.length=0;for(var a=0;a<i;a++){const i=(s=n[a]).hasPoint(e);s.loc=i.loc,i.flag?t.selectedElements.push(s):t.unSelectedElements.push(s)}for(;a<i;a++)s=n[a],t.unSelectedElements.push(s)}delete(e=null){const t=this._data,n=t.length;let i=-1;for(let s=0;s<n;s++)if(e===t[s]){i=s;break}t.splice(i,1)}reset(){this._data.length=0,this.selectedElements.length=0,this.unSelectedElements.length=0}}var l=new class{constructor(){this._targets={}}getTargets(e=""){const t=this._getEventTypePrefix(e);return t?this._targets[t]:null}addTarget(e="",t=null){const n=this._targets,i=this._getEventTypePrefix(e);if(!i)return;n.hasOwnProperty(i)||(n[i]=new r);const s=n[i];s.contains(t)||s.add(t)}removeTarget(e="",t=null){const n=this._targets,i=this._getEventTypePrefix(e);i&&n.hasOwnProperty(i)&&n[e].delete(t)}_filterSupportEventType(e=""){let t=null;return 0===e.indexOf("mouse")&&(t="mouse"),"click"===e&&(t="click"),"contextmenu"===e&&(t="contextmenu"),t}_getEventTypePrefix(e=""){return e?this._filterSupportEventType(e):null}};class o{constructor(){this._listeners={},this.inBounds=!1}hasListener(e="",t=""){const n=this._listeners;return n[e]&&n[e].hasOwnProperty(t)}addListener(e="",t="",n=null){const i=this._listeners;e&&t&&n&&(i[e]||(i[e]={}),i[e].hasOwnProperty(t)||(i[e][t]=[]),i[e][t].push(n),l.addTarget(t,this))}fire(t={}){const n=this,{scope:i="",type:s="",FENodeEvent:a=null,attach:r=null,eventFrom:l=""}=t,o=n._listeners,h=n.loc;if(i&&s&&null!==a&&null!==a.type){if("array"===e.typeOf(o[i][a.type])){const t=o[i][a.type],c=t.length;if(c){const i=[];for(let o=0;o<c;o++){const c=e.get(a,"target.options.data",{}),d=e.get(r,"event",{}),u=d.x+h.x,g=d.y+h.y,p=u+c.width,m=g+c.height;t[o].call(n,{type:s,target:c,targetPath:c.path,targetAttach:c.attachInfo,event:d,eventFrom:l,shapePoint:{topLeft:{x:u,y:g},topRight:{x:p,y:g},bottomLeft:{x:u,y:m},bottomRight:{x:p,y:m}}}),i.push({target:c,targetPath:c.path,targetAttach:c.attachInfo})}return i}}return null}}removeListener(t="",n="",i=null){const s=this,a=s._listeners;if(t&&n&&i&&(null===i&&a[t]&&a[t].hasOwnProperty(n)&&(a[t][n]=[],l.removeTarget(n,s)),"array"===e.typeOf(a[t][n]))){const e=a[t][n],s=e.length;for(let t=0;t<s;t++)if(e[t]===i){e.splice(t,1),e.length||l.removeTarget(n,this);break}}}}class h extends o{constructor(e,t){super(),this.canvas=e,this.context=t,this.options=null}draw(e){}compareTo(e){return null}comparePointX(e){return null}hasPoint(e){return!1}}const c={Circle:class extends h{constructor(e=null,t=null){super(e,t)}draw(e={}){const t=this;return new Promise((n,i)=>{a.draw("circle",t.context,e).then(e=>{t.options=e,t.options.shapeMinX=t.options.cx-t.options.r,n()}).catch(e=>{i(e)})})}compareTo(t=null){return e.compareXY(this.options.shapeMinX,t.options.shapeMinX)}comparePointX(t=null){return e.compareXY(this.options.shapeMinX,t.x)}hasPoint(e=null){return a.containPoint("circle",e,this.options)}},Rectangle:class extends h{constructor(e,t){super(e,t)}draw(e={}){const t=this;return new Promise((n,i)=>{a.draw("rectangle",t.context,e).then(e=>{t.options=e,t.options.shapeMinX=t.options.x,n()}).catch(e=>{i(e)})})}compareTo(t=null){return e.compareXY(this.options.shapeMinX,t.options.shapeMinX)}comparePointX(t=null){return e.compareXY(this.options.shapeMinX,t.options.shapeMinX)}hasPoint(e=null){return a.containPoint("rectangle",e,this.options)}},PolygonXYs:class extends h{constructor(e,t){super(e,t)}draw(e={}){const t=this;return new Promise((n,i)=>{a.draw("polygonXYs",t.context,e).then(e=>{t.options=e,t.options.shapeMinX=t.options.cx-t.options.r,n()}).catch(e=>{i(e)})})}}},d=["click","mousemove","mouseover","mouseout","contextmenu"],u={_draw:async(e=null,t=null,n={})=>{const{eventObj:i={},opts:s={}}=n,{shapeOrigin:a=""}=s,{scope:r="",events:l={}}=i;let o=null;switch(a){case"circle":o=new c.Circle(e,t);break;case"rectangle":s.rBorder=0,o=new c.Rectangle(e,t);break;case"round-rectangle":o=new c.Rectangle(e,t)}o&&await o.draw(s).then(()=>{r&&d.forEach(e=>{o.addListener(r,e,l[e])})})},shape:async(e=null,t=null,n=null)=>{await u._draw(e,t,n)},shapeHighlight:async(e=null,t=null,n=null)=>{const{fillOpts:i=null,strokeOpts:s=null}=n;i&&await u._draw(e,t,{opts:i}),s&&await u._draw(e,t,{opts:s})},shapeHover:async(e=null,t=null,n=null)=>{await u._draw(e,t,{opts:n})}};const g={};g.parse=((n="",s=null)=>{var a=new class{constructor(e=""){this.scope=e,this.id=null,this.text="",this.shape="",this.siblingsWidth=null,this.stepWidth=0,this.maxY=null,this.path=null,this.attachInfo=null,this.children=[],this.hasChildren,this.first=null,this.last=null,this.parent=null,this.next=null,this.previous=null,this.siblingsIndex=null,this.x=null,this.y=null}setParentSiblings(e=null,t=null){if(this.parent=t,this.hasChildren=this.children&&this.children.length>0,this.siblingsIndex=e,this.hasChildren){const e=this.children.length;this.first=this.children[0],this.last=this.children[e-1];for(let t=0;t<e-1;t++)this.children[t].next=this.children[t+1];for(let t=1;t<e;t++)this.children[t].previous=this.children[t-1];for(let t=0;t<e;t++)this.children[t].setParentSiblings(t,this)}}setPath(){const e=t._getTargetPath(this);if(this.path="",this.attachInfo=null,e&&e.length){const t=e.length;e.forEach(e=>{this.path+=`.children[${e}]`}),this.path&&(this.path=this.path.substr(1)),this.attachInfo={parentPath:"",index:null},e.forEach((e,n)=>{n<t-1?this.attachInfo.parentPath+=`.children[${e}]`:n===t-1&&(this.attachInfo.index=e)}),this.attachInfo.parentPath&&(this.attachInfo.parentPath=this.attachInfo.parentPath.substr(1))}if(this.hasChildren){const e=this.children.length;for(let t=0;t<e;t++)this.children[t].setPath()}}setHorizontalWidth(e=1,t={}){const{styles:n}=t,{size:i,gutter:s}=n,{width:a,height:r}=i,l=a*e,o=r*e,h=s.horizontal*e;this.width=l,this.height=o;for(let n=this.first;null!==n;n=n.next)n.setHorizontalWidth(e,t);if(!this.hasChildren)return this.leftWidth=l/2,void(this.rightWidth=l/2);for(let e=this.first;null!==e&&null!==e.next;e=e.next){const t=e.rightWidth+h/2+e.next.leftWidth;this.stepWidth=Math.max(this.stepWidth,t)}if(this.leftWidth=0,this.rightWidth=0,this.hasChildren){const e=this.children.length-1;this.siblingsWidth=e*this.stepWidth,this.leftWidth=this.siblingsWidth/2+this.first.leftWidth,this.rightWidth=this.siblingsWidth/2+this.last.rightWidth}this.leftWidth=Math.max(this.leftWidth,l/2+h/2),this.rightWidth=Math.max(this.rightWidth,l/2+h/2)}adjustHeight(){this.maxY=this.y;for(let e=this.first;null!==e;e=e.next)this.maxY=Math.max(this.maxY,e.adjustHeight());return this.maxY}assignLocation(e=0,t=0,n=1,i={}){const{__boundaryPoint:s,styles:a}=i,{gutter:r}=a;if(s.x.min=Math.min(s.x.min,e),s.x.max=Math.max(s.x.max,e),s.y.min=Math.min(s.y.min,t),s.y.max=Math.max(s.y.max,t),this.x=Math.floor(e)+.5,this.y=Math.floor(t)+.5,this.hasChildren){const s=this.children.length,a=e-this.siblingsWidth/2;for(let e=0;e<s;e++){const s=a+e*this.stepWidth,l=t+this.height+r.vertical*n/2;this.children[e].assignLocation(s,l,n,i)}}}collectBaseDataOfShape(n={},i=""){const{scaleRatio:s,styles:a}=n,{shape:r}=a,{_shape:l,_shapeOrigin:o}=t.getShapeAndShapeOrigin(this),h=e.get(r,`${l}.bg`)||e.get(r,`${o}.bg`),c=e.get(r,`${l}.bgImg`)||e.get(r,`${o}.bgImg`),d=e.get(r,`${l}.rBorder`)||e.get(r,`${o}.rBorder`)||2,u={scaleRatio:s,shapeOrigin:o,x:this.x-this.width/2,y:this.y,w:this.width,h:this.height,bgImg:c,rBorder:d,data:this};return"fill"===i?e.merge(u,{type:i,fillColor:h}):"stroke"===i&&e.merge(u,{type:i,strokeColor:h}),u}async _drawShape(e=null,t=null,n={}){const i={opts:this.collectBaseDataOfShape(n,"fill"),eventObj:{scope:this.scope,events:n.events}};await u.shape(e,t,i)}async _drawShapeHighlight(n=null,i=null,s={}){const a=e.get(this,"highlight.type"),r=t.collectHighlightDataOfShape(a,this,s);r&&await u.shapeHighlight(n,i,r)}_fillText(t=null,n=null,i={}){const{scaleRatio:s,styles:a}=i,{shape:r}=a,l=e.get(this,"shape"),o=l.split("__")[0],h=e.get(r,`${l}.text.family`)||e.get(r,`${o}.text.family`),c=e.get(r,`${l}.text.size`)||e.get(r,`${o}.text.size`),d=e.get(r,`${l}.text.lineHeight`)||e.get(r,`${o}.text.lineHeight`);let u=(e.get(r,`${l}.text.indent`)||e.get(r,`${o}.text.indent`))*s;const g=e.get(r,`${l}.text.maxLen`)||e.get(r,`${o}.text.maxLen`),p=`${c*s}px/${d*s}px ${h}`,m=(this.text||"").length>g?`${this.text.substr(0,g)}..`:this.text,f=e.get(r,`${l}.text.color`)||e.get(r,`${o}.text.color`),v=e.get(r,`${l}.text.align`)||e.get(r,`${o}.text.align`);n.font=p,n.textBaseline="middle",n.fillStyle=f,n.textAlign=v,"center"===n.textAlign&&(u=this.width/2),n.fillText(m,this.x-this.width/2+u,this.y+this.height/2)}_drawLine(t=null,n=null,i={}){const{scaleRatio:s,styles:a}=i,{line:r}=a,l=e.get(r,"color","#000"),o=e.get(r,"width",1)*s,h=e.get(r,"borderRadius",6)*s,d=this.parent.x,u=this.parent.y+this.parent.height,g=this.x,p=this.y,m=d,f=u+(p-u)/2,v=d>g?g+h:d<g?g-h:g,y=f,x=g,w=f+h;n.beginPath(),n.lineWidth=o,n.strokeStyle=l;const b=4*o,_=1.5*b;n.moveTo(d,u),n.lineTo(m,f),n.lineTo(v,y),n.quadraticCurveTo(g,y,x,w),n.lineTo(g,p),n.stroke();const E={x:g-b,y:p-_,w:2*b,h:_,type:"fill",fillColor:l,polygonXYsArr:[{x:g-b,y:p-_},{x:g+b,y:p-_},{x:g,y:p}]};new c.PolygonXYs(t,n).draw(E)}async draw(e=null,t=null,n={}){await this._drawShape(e,t,n),await this._drawShapeHighlight(e,t,n),await this._fillText(e,t,n);for(let i=this.first;null!==i;i=i.next)await i.draw(e,t,n);this.parent&&await this._drawLine(e,t,n)}translateX(e=1,t=0){t+i.padding*e<=0||this._doTranslateX(t)}_doTranslateX(e=0){if(this.x+=e,this.hasChildren){const t=this.children.length;for(let n=0;n<t;n++)this.children[n]._doTranslateX(e)}}}(n);return Object.keys(s).forEach(e=>{"children"!==e&&(a[e]=s[e])}),g.hasChildren(s)&&(a.children=[],s.children.forEach(e=>{a.children.push(g.parse(n,e))})),a}),g.hasChildren=(e=>e.children&&e.children.length);class Event{constructor(e=-1,t=-1,n=null,i=null){this.x=e,this.y=t,this.type=n,this.target=i}}const p={domEl:"j-class-drag-scroll",_window:window,mousemove:"mousemove",mouseup:"mouseup",mousedown:"mousedown",addEventListener:"addEventListener",removeEventListener:"removeEventListener",dragged:[],cancel:!1,noop(){},reset(e=0,t=null){for(e=0;e<p.dragged.length;)(t=p.dragged[e++])[p.removeEventListener](p.mousedown,t.md,0),p._window[p.removeEventListener](p.mouseup,t.mu,0),p._window[p.removeEventListener](p.mousemove,t.mm,0);if(!p.cancel)for(p.dragged=document.getElementsByClassName(p.domEl),e=0;e<p.dragged.length;)((e=null,t=0,n=0,i=0)=>{e[p.addEventListener](p.mousedown,e.md=((e=null)=>{i=1,t=e.clientX,n=e.clientY,e.preventDefault(),e.stopPropagation()}),!1),p._window[p.addEventListener](p.mouseup,e.mu=(()=>{i=0}),!1),p._window[p.addEventListener](p.mousemove,e.mm=((s=null,a=null)=>{a=e.scroller||e,i&&(a.scrollLeft-=-t+(t=s.clientX),a.scrollTop-=-n+(n=s.clientY))}),!1)})(p.dragged[e++])}},m={dragScroll:(e={})=>{const{cancel:t=!1}=e;p.cancel=t,p._window[p.addEventListener]("load",p.reset,!1),p.reset()}};class f{constructor(){this.scope="scope",this.wrapSize=null,this.realSize=null,this.finalWidth=null,this.finalHeight=null,this.optWrapDomEle=null,this.domObj=null,this.idPrefix="j-fe-canvas",this.canvas=null,this.context=null,this.cId=`${this.idPrefix}`,this.cZIndex=1,this.canvasHover=null,this.contextHover=null,this.cIdHover=`${this.idPrefix}-hover`,this.cZIndexHover=2,this.canvasActive=null,this.contextActive=null,this.cIdActive=`${this.idPrefix}-active`,this.cZIndexActive=3,this.renderRatio=1,this.jsonView=null,this.options=i.originOptions(),this.selectedFENodes=[],this.scale={ratio:1,min:.5,max:3},this.clickEvtFlag=!1,this.contextmenuEvtFlag=!1,this.mouseEvtFlag=!1}_setUniqueId(e=""){this[`cId${e}`]=t._addUniqueSuffix(this[`cId${e}`])}_setScopeUnique(){this.scope=t._addUniqueSuffix(this.scope)}_resetSomeData(){this.selectedFENodes.splice(0,this.selectedFENodes.length)}_setScale(e=1){this.scale.ratio=e}setWrapSize(){const{domEleSizeNumber:t={}}=this.domObj;this.wrapSize=e.deepClone(t)}setOrigin(){this.options.__originPoint.x=this.wrapSize.width/2,this.options.__originPoint.y=i.padding}_filterValidCanvas(t=""){return e.arrayContainsVal(i.canvasList,t)}_createSingleCanvas(t=""){const s=this.wrapSize,a=i.canvasList[0].length;if(!this._filterValidCanvas(t))return;const r=t.substr(a),l=`context${r}`;this[t]=n.create("canvas");const o=this[t];this[l]=o.getContext("2d");const h=this[l],c=this.renderRatio=e.getPixelRatio(h),d=this.realSize={width:s.width/c,height:s.height/c};o.style.width=`${d.width}px`,o.style.height=`${d.height}px`,o.width=s.width*c,o.height=s.height*c,this._setUniqueId(r),o.id=this[`cId${r}`],o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.zIndex=this[`cZIndex${r}`],r&&(o.style.pointerEvents="none")}_setSingleCanvasStyle(e="",t=1,n={}){if(!this._filterValidCanvas(e))return;const i=this[e],{w:s,h:a}=n;i.style.width=`${s}px`,i.style.height=`${a}px`,i.width=s*t,i.height=a*t}createCanvasCtx(){const e=this;try{e.setWrapSize(),e.setOrigin(),i.canvasList.forEach(t=>{e._createSingleCanvas(t)})}catch(e){throw"canvas"}}create(t={}){const{domObj:n,data:s,options:a}=t;return this.domObj=e.deepClone(n),e.merge(this.options,a),e.merge(this.options,i.privateOriginPoint()),e.merge(this.options,i.privateBoundaryPoint()),this._setScopeUnique(),this.createCanvasCtx(),this.calcLayoutDrawInCanvas(s)}update(t={}){return e.merge(this.options,i.privateBoundaryPoint()),this.calcLayoutDrawInCanvas(t)}initLayout(){const e=this.jsonView,t=this.options,n=t.__originPoint,i=this.scale.ratio;e.setParentSiblings(),e.setPath(),e.setHorizontalWidth(i,t),e.assignLocation(n.x,n.y*i,i,t),e.adjustHeight()}setFinalSize(){const e=this.jsonView,t=this.scale.ratio;this.finalWidth=e.leftWidth+e.rightWidth+2*i.padding*t+2*i.hiddenWidth/3,this.finalHeight=e.maxY+3*i.padding*t+2*i.hiddenWidth/3}calcLayoutDrawInCanvas(t={}){const n=this;n._resetSomeData(),n.jsonView=g.parse(n.scope,t),e.merge(n.options,{scaleRatio:n.scale.ratio});const s=n.jsonView,a=n.options,{__boundaryPoint:r}=a;n.initLayout(),n.setFinalSize();const o=n.canvas,h=n.context,c=n.renderRatio,d=n.wrapSize,u={w:Math.max(d.width,n.finalWidth,r.x.max-r.x.min),h:Math.max(d.height,n.finalHeight,r.y.max-r.y.min)};i.canvasList.forEach(e=>{n._setSingleCanvasStyle(e,c,u)});const p=Math.floor(s.leftWidth+i.padding*n.scale.ratio)-d.width/2;s.translateX(n.scale.ratio,p),h.scale(c,c),s.draw(o,h,a),l._targets={};const m=[];return i.canvasList.forEach(e=>{m.push(n[e])}),{res:m,options:a}}enableClick(){const e=this,t=e.canvas;e.clickEvtFlag=!0,t.addEventListener("click",t=>{e._handleClick("click",t,e)},!1)}_handleClick(e="",t=null,n=null){this._handleEvt({type:e,event:t,target:n})}enableMouse(){const e=this,t=e.canvas;e.mouseEvtFlag=!0,t.addEventListener("mousemove",t=>{e._handleMouse("mousemove",t,e)},!1),t.addEventListener("mouseover",t=>{e._handleMouse("mouseover",t,e)},!1),t.addEventListener("mouseout",t=>{e._handleMouse("mouseout",t,e)},!1)}_handleMouse(e="",t=null,n=null){this._handleEvt({type:e,event:t,target:n})}enableContextmenu(){const e=this,t=e.canvas;e.contextmenuEvtFlag=!0,t.addEventListener("contextmenu",t=>{t.preventDefault(),e._handleContextmenu("contextmenu",t,e)},!1)}_handleContextmenu(e="",t=null,n=null){this._handleEvt({type:e,event:t,target:n})}_handleEvt(t={}){const i=this,{type:s="",event:a=null,target:r=null,canvasPoint:o=null}=t,h=o&&"object"===e.typeOf(o),c=h?o:r._windowToCanvas(a.clientX,a.clientY),d=h?"simulation":"trigger",u=0===s.indexOf("mouse"),g=u?"mouse":s,p=l.getTargets(g);if(null===p)"clickEmpty"===s&&i._handleNoTargets({type:s,event:a,point:c,eventFrom:d});else{p.search(c);const t=e.get(p,"selectedElements",[]),l=e.get(p,"unSelectedElements",[]);t.length?t.forEach(e=>{u?(i._listenerFire({type:"mousemove",event:a,target:r,ele:e,point:c,eventFrom:d}),e.inBounds||(e.inBounds=!0,i._listenerFire({type:"mouseover",event:a,target:r,ele:e,point:c,eventFrom:d}))):("contextmenu"===s&&(n.disabledMouseWheel({domEle:i.optWrapDomEle}),m.dragScroll({cancel:!0})),i._listenerFire({type:s,event:a,target:r,ele:e,point:c,eventFrom:d}))}):("click"===s&&i._handleNoTargets({type:"clickEmpty",event:a,point:c,eventFrom:d}),"contextmenu"===s&&i._handleNoTargets({type:"contextmenuEmpty",event:a,point:c,eventFrom:d})),u&&l.length&&l.forEach(e=>{e.inBounds&&(e.inBounds=!1,i._listenerFire({type:"mouseout",event:a,target:r,ele:e,point:c,eventFrom:d}))})}}_listenerFire(e={}){const t=this,{type:n="",event:i=null,target:s=null,ele:a=null,point:r=null,eventFrom:l=""}=e;if(a.hasListener(t.scope,n)){const o=new Event(r.x,r.y,n,a);"click"!==n&&"contextmenu"!==n||t._doClickDraw(e),"mouseover"===n&&t._doHoverDraw(e),"mouseout"===n&&t._doHoverDraw(),s.canvas.style.cursor="mouseout"===n?"":"default";const h={scope:t.scope,type:n,FENodeEvent:o,attach:{event:i,target:s},eventFrom:l},c=a.fire(h)||[];"click"!==n&&"contextmenu"!==n||(t.selectedFENodes.splice(0,t.selectedFENodes.length),c.length&&c.forEach(e=>{t.selectedFENodes.push(e)}))}}_doClickDraw(e=null){this._doHighlightDraw("active",e)}_doHoverDraw(e=null){this._doHighlightDraw("hover",e)}async _doHighlightDraw(n="",i=null){const s=this;if(!n||!e.arrayContainsVal(["hover","active"],n))return;const a=`${n.substring(0,1).toUpperCase()}${n.substring(1)}`;if(s[`_clearCav${a}`](),i){const r=e.get(i,"target.options",{}),l=e.get(i,"ele.options.data",{}),o=t.collectHighlightDataOfShape(n,l,r),h=s[`canvas${a}`],c=s[`context${a}`];c.scale(s.renderRatio,s.renderRatio),o&&await u.shapeHighlight(h,c,o)}}_windowToCanvas(e=0,t=0){const n=this.canvas.getBoundingClientRect();return{x:e-n.left,y:t-n.top}}_handleNoTargets(t){const i=this,{type:s="",event:a=null,point:r=null}=t;if(n.disabledMouseWheel({domEle:i.optWrapDomEle,flag:!1}),m.dragScroll(),i._clearCavActive(),i.selectedFENodes.splice(0,i.selectedFENodes.length),i.clickEvtFlag||i.contextmenuEvtFlag||i.mouseEvtFlag){const t=e.get(i,"options.events.clickEmpty",null);t&&"function"===e.typeOf(t)&&t.call(i,{type:"clickEmpty",target:null,targetPath:null,targetAttach:null,event:a,shapePoint:null})}}_clearCavActive(){this.canvasActive.height=this.canvasActive.height}_clearCavHover(){this.canvasHover.height=this.canvasHover.height}}const v={_create2ImageCvs(e=null){const t=n.create("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,t.style.width=e.style.width,t.style.height=e.style.height,{cvsImg:t,ctxImg:i}},_checkBeforeDoAfterCreateAction(n=null){const i=e.get(n,"cacheFE.create",{}),s=i.el&&i.options&&i.mainCanvas;if(!s)throw new Error(t._makeConsoleStr(["Project FlowEditor does not exist! Create the canvas first.","You may need: `const flowEditor = new FlowEditor()`","and call method: `flowEditor.create(conf)` create."]));return s},_beforeMergeCanvasLayer:(n={},i={})=>new Promise((s,a)=>{const{withBg:r=!0,type:l="png",base64:o=!0}=n,{cvsImg:h,ctxImg:c,createOptions:d}=i,u=e.get(d,"styles.canvas",{}),g={type:"image/",base64:o};if("jpg"===l&&(g.type+="jpeg"),r){const e=(e,t)=>{c.fillStyle=e,c.fillRect(0,0,h.width,h.width),t(g)};if(u.bgImg){const n=t.createCrossOriginImage(u.bgImg);n.onload=(()=>{e(c.createPattern(n,"repeat"),s)})}else e(u.bg,s)}else s(g)})};return class{constructor(){this.originData={css:{position:"absolute",left:"0",top:"0",right:`-${i.hiddenWidth}px`,bottom:`-${i.hiddenWidth}px`,overflow:"scroll",background:"transparent"},outerWrapId:"j-fe-canvas-outer-wrap",outerWrapClassName:"class-fe-canvas-outer-wrap",wrapId:"j-fe-canvas-inner-wrap",wrapClassName:"class-fe-canvas-inner-wrap"},this.cacheFE={cvsArr:[],innerDomEle:null,create:{el:null,options:null,eventBind:null,domEle:null,domEleStyles:null,sizeStyle:null,sizeStyleNumber:null,outerStyle:{position:"relative",overflow:"hidden"},baseStyle:{},createOptions:{}}},this.selectedFENodes=null}create(i={}){try{const a=this,{el:r="",data:l={},options:o={}}=i,h=a.cacheFE,c=a.cacheFE.create,{click:d=!1,contextmenu:u=!1,mouse:g=!1}=e.get(o,"eventBind",{});c.el=r,c.data=e.deepClone(l),c.options=o,c.domEle=n.$(r),c.domEleStyles=window.getComputedStyle(c.domEle,null),c.eventBind={click:d,contextmenu:u,mouse:g},c.sizeStyle={width:c.domEleStyles.width,height:c.domEleStyles.height};const{width:p,height:v}=c.sizeStyle;c.sizeStyleNumber={width:Number(e.removeSuffix(p,"px")),height:Number(e.removeSuffix(v,"px"))},h.innerDomEle=null,h.innerDomEle=n.create("div");const y=h.innerDomEle,x=a.originData;x.wrapId=t._addUniqueSuffix(x.wrapId),x.wrapClassName=t._addUniqueSuffix(x.wrapClassName),x.outerWrapId=t._addUniqueSuffix(x.outerWrapId),x.outerWrapClassName=t._addUniqueSuffix(x.outerWrapClassName);const{css:w,wrapId:b,wrapClassName:_,outerWrapId:E,outerWrapClassName:C}=a.originData;y.id=b,y.className+=`${_} j-class-drag-scroll`,c.mainCanvas=new f;const S={domObj:{domEle:c.domEle,domEleSizeNumber:c.sizeStyleNumber},data:l,options:o},k=c.mainCanvas.create(S);h.cvsArr=e.get(k,"res",[]),c.createOptions=e.get(k,"options",{});const{canvas:P}=c.createOptions.styles;c.outerStyle.background=P.bgImg?`url(${P.bgImg})`:`${P.bg||"#fff"}`,e.merge(c.outerStyle,c.sizeStyle),e.merge(c.baseStyle,w);const $=n.create("div");$.id=E,$.className+=C;const O=`\n                ${s.createStyleStr(C,c.outerStyle)}\n                ${s.createStyleStr(_,c.baseStyle)}\n                ${s.getCustomScrollbarStyle(_)}\n                ${s.getDraggGrabStyle(_)}\n            `;n.createStyle(O),d&&c.mainCanvas.enableClick(),u&&c.mainCanvas.enableContextmenu(),g&&c.mainCanvas.enableMouse(),h.cvsArr.forEach(e=>{n.inject(e,y)}),m.dragScroll(),n.html(c.domEle,""),n.inject(y,$),n.inject($,c.domEle),c.mainCanvas.optWrapDomEle=$,a.selectedFENodes=c.mainCanvas.selectedFENodes}catch(e){throw"canvas"===e&&n.text("Your browser does not support the Canvas HTML element."),new Error(e)}return!1}update(t={}){const n=this;if(v._checkBeforeDoAfterCreateAction(n)){const i=e.get(n,"cacheFE.create",{});i.data=null,i.data=e.deepClone(t),i.mainCanvas.update(t)}}setSelected(n=""){const s=this;if(v._checkBeforeDoAfterCreateAction(s)){const a=e.get(s,"cacheFE.create",{}),r=e.get(a.mainCanvas.jsonView,`${n}`,null);if(!r)throw new Error(t._makeConsoleStr([`FENode path does't exist: ${n} .Please check it.`]));const l={type:"click",canvasPoint:{x:r.x+1,y:r.y+1},target:a.mainCanvas};setTimeout(()=>{a.mainCanvas._handleEvt(l)},i.DELAY.simulateClick)}}setUnSelected(){const t=this;if(v._checkBeforeDoAfterCreateAction(t)){const n=e.get(t,"cacheFE.create",{}),s={type:"clickEmpty",canvasPoint:{x:-1,y:-1},target:n.mainCanvas};setTimeout(()=>{n.mainCanvas._handleEvt(s)},i.DELAY.simulateClick)}}scale(t=1){const n=this;if(v._checkBeforeDoAfterCreateAction(n)){const i=e.get(n,"cacheFE.create",{}),s=i.mainCanvas;t&&"number"===e.typeOf(t)&&s.scale.min<=t&&t<=s.scale.max&&(s._setScale(t),s.update(i.data))}}find(t={},n="",i=""){return e.get(t,n,i)}getImage(t={}){const i=this;return new Promise((s,a)=>{if(v._checkBeforeDoAfterCreateAction(i)){const a=e.get(i,"cacheFE.create.createOptions",{}),r=e.get(i,"cacheFE.cvsArr",[]),l=r[0],{cvsImg:o,ctxImg:h}=v._create2ImageCvs(l),c={cvsImg:o,ctxImg:h,createOptions:a};v._beforeMergeCanvasLayer(t,c).then((e={})=>{r.forEach(e=>{h.drawImage(e,0,0,o.width,o.height)});const t=o.toDataURL(e.type);if(e.base64)s(t);else{const e=n.create("a"),i=new MouseEvent("click");e.download="flow-editor-pro",e.href=t,e.dispatchEvent(i)}})}else a()})}}});
